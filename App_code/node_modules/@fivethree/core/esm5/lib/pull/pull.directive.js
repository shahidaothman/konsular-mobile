/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, ElementRef, Input, Output, EventEmitter } from '@angular/core';
import { IonContent, Platform } from '@ionic/angular';
import { fromEvent, merge } from 'rxjs';
import { filter, map, skipWhile, takeUntil, takeLast } from 'rxjs/operators';
var FivPull = /** @class */ (function () {
    function FivPull(element, platform, content) {
        this.element = element;
        this.platform = platform;
        this.content = content;
        this.minPullHeight = 112;
        this.maxPullHeight = 168;
        this.enabled = true;
        this.enableScroll = false;
        this.direction = 'down';
        this.fivRefresh = new EventEmitter();
        this.fivCancel = new EventEmitter();
        this.fivPull = new EventEmitter();
    }
    /**
     * @return {?}
     */
    FivPull.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.content.scrollEvents = true;
        this.content.getScrollElement().then((/**
         * @param {?} s
         * @return {?}
         */
        function (s) {
            _this.scrollY = s; // needed for scrollTop
            _this.setupPanListener();
        }));
    };
    /**
     * @private
     * @return {?}
     */
    FivPull.prototype.setupPanListener = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var touchstart$ = fromEvent(this.element.nativeElement, 'touchstart', { passive: true });
        /** @type {?} */
        var touchmove$ = fromEvent(this.element.nativeElement, 'touchmove', { passive: true });
        /** @type {?} */
        var touchend$ = fromEvent(this.element.nativeElement, 'touchend', { passive: true });
        /** @type {?} */
        var touchcancel$ = fromEvent(this.element.nativeElement, 'touchcancel', { passive: true });
        /** @type {?} */
        var end$ = merge(touchend$, touchcancel$);
        /** @type {?} */
        var dragAtTop = touchstart$.pipe(filter((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            return (_this.scrollY.scrollTop === 0 || _this.enableScroll) &&
                _this.direction === 'down' &&
                _this.enabled;
        })));
        /** @type {?} */
        var dragAtBottom = touchstart$.pipe(filter((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            return (_this.scrollY.scrollTop ===
                _this.scrollY.clientHeight - _this.platform.height() ||
                _this.enableScroll) &&
                _this.direction === 'up' &&
                _this.enabled;
        })));
        /** @type {?} */
        var dragTopDown = dragAtTop.pipe(map((/**
         * @param {?} start
         * @return {?}
         */
        function (start) {
            /** @type {?} */
            var startY = start.touches[0].pageY;
            return touchmove$.pipe(map((/**
             * @param {?} move
             * @return {?}
             */
            function (move) {
                /** @type {?} */
                var currentY = move.touches[0].pageY;
                return {
                    startEvent: start,
                    moveEvent: move,
                    startY: startY,
                    currentY: currentY,
                    offset: currentY - startY
                };
            })), skipWhile((/**
             * @param {?} drag
             * @return {?}
             */
            function (drag) { return drag.offset < 0; })), takeUntil(end$));
        })));
        dragTopDown.forEach((/**
         * @param {?} drags
         * @return {?}
         */
        function (drags) {
            drags.forEach((/**
             * @param {?} drag
             * @return {?}
             */
            function (drag) {
                /** @type {?} */
                var offset = drag.offset / 2;
                if (offset < 0 || offset > _this.maxPullHeight) {
                    return;
                }
                if (offset <= _this.maxPullHeight) {
                }
                _this.fivPull.emit(offset / _this.maxPullHeight);
            }));
            drags.pipe(takeLast(1)).subscribe((/**
             * @param {?} drag
             * @return {?}
             */
            function (drag) {
                /** @type {?} */
                var offset = drag.offset / 2;
                /** @type {?} */
                var refresh = offset >= _this.minPullHeight;
                if (refresh) {
                    _this.fivRefresh.emit(offset / _this.maxPullHeight);
                }
                else {
                    _this.fivCancel.emit(offset / _this.maxPullHeight);
                }
            }));
        }));
        /** @type {?} */
        var dragBottomUp = dragAtBottom.pipe(map((/**
         * @param {?} start
         * @return {?}
         */
        function (start) {
            /** @type {?} */
            var startY = start.touches[0].pageY;
            return touchmove$.pipe(map((/**
             * @param {?} move
             * @return {?}
             */
            function (move) {
                /** @type {?} */
                var currentY = move.touches[0].pageY;
                return {
                    startEvent: start,
                    moveEvent: move,
                    startY: startY,
                    currentY: currentY,
                    offset: startY - currentY
                };
            })), skipWhile((/**
             * @param {?} drag
             * @return {?}
             */
            function (drag) { return drag.offset < 0; })), takeUntil(end$));
        })));
        dragBottomUp.forEach((/**
         * @param {?} drags
         * @return {?}
         */
        function (drags) {
            drags.forEach((/**
             * @param {?} drag
             * @return {?}
             */
            function (drag) {
                /** @type {?} */
                var offset = drag.offset / 2;
                if (offset < 0 || offset > _this.maxPullHeight) {
                    return;
                }
                _this.fivPull.emit(offset / _this.maxPullHeight);
            }));
            drags.pipe(takeLast(1)).subscribe((/**
             * @param {?} drag
             * @return {?}
             */
            function (drag) {
                /** @type {?} */
                var offset = drag.offset / 2;
                /** @type {?} */
                var refresh = offset >= _this.minPullHeight;
                if (refresh) {
                    _this.fivRefresh.emit(offset / _this.maxPullHeight);
                }
                else {
                    _this.fivCancel.emit(offset / _this.maxPullHeight);
                }
            }));
        }));
    };
    FivPull.decorators = [
        { type: Directive, args: [{
                    selector: '[fivPull]'
                },] }
    ];
    /** @nocollapse */
    FivPull.ctorParameters = function () { return [
        { type: ElementRef },
        { type: Platform },
        { type: IonContent }
    ]; };
    FivPull.propDecorators = {
        minPullHeight: [{ type: Input }],
        maxPullHeight: [{ type: Input }],
        enabled: [{ type: Input }],
        enableScroll: [{ type: Input }],
        direction: [{ type: Input }],
        fivRefresh: [{ type: Output }],
        fivCancel: [{ type: Output }],
        fivPull: [{ type: Output }]
    };
    return FivPull;
}());
export { FivPull };
if (false) {
    /** @type {?} */
    FivPull.prototype.minPullHeight;
    /** @type {?} */
    FivPull.prototype.maxPullHeight;
    /** @type {?} */
    FivPull.prototype.enabled;
    /** @type {?} */
    FivPull.prototype.enableScroll;
    /** @type {?} */
    FivPull.prototype.direction;
    /** @type {?} */
    FivPull.prototype.fivRefresh;
    /** @type {?} */
    FivPull.prototype.fivCancel;
    /** @type {?} */
    FivPull.prototype.fivPull;
    /** @type {?} */
    FivPull.prototype.scrollY;
    /**
     * @type {?}
     * @private
     */
    FivPull.prototype.element;
    /**
     * @type {?}
     * @private
     */
    FivPull.prototype.platform;
    /**
     * @type {?}
     * @private
     */
    FivPull.prototype.content;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHVsbC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZml2ZXRocmVlL2NvcmUvIiwic291cmNlcyI6WyJsaWIvcHVsbC9wdWxsLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFFVCxVQUFVLEVBQ1YsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBQ2IsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN4QyxPQUFPLEVBQ0wsTUFBTSxFQUNOLEdBQUcsRUFDSCxTQUFTLEVBQ1QsU0FBUyxFQUNULFFBQVEsRUFDVCxNQUFNLGdCQUFnQixDQUFDO0FBRXhCO0lBZ0JFLGlCQUNVLE9BQW1CLEVBQ25CLFFBQWtCLEVBQ2xCLE9BQW1CO1FBRm5CLFlBQU8sR0FBUCxPQUFPLENBQVk7UUFDbkIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixZQUFPLEdBQVAsT0FBTyxDQUFZO1FBZnBCLGtCQUFhLEdBQUcsR0FBRyxDQUFDO1FBQ3BCLGtCQUFhLEdBQUcsR0FBRyxDQUFDO1FBQ3BCLFlBQU8sR0FBRyxJQUFJLENBQUM7UUFDZixpQkFBWSxHQUFHLEtBQUssQ0FBQztRQUNyQixjQUFTLEdBQWtCLE1BQU0sQ0FBQztRQUVqQyxlQUFVLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUNyQyxjQUFTLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUNwQyxZQUFPLEdBQUcsSUFBSSxZQUFZLEVBQVUsQ0FBQztJQVEzQyxDQUFDOzs7O0lBRUwsMEJBQVE7OztJQUFSO1FBQUEsaUJBTUM7UUFMQyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7UUFDakMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0Is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Z0JBakJDLFVBQVU7Z0JBS1MsUUFBUTtnQkFBcEIsVUFBVTs7O2dDQWNoQixLQUFLO2dDQUNMLEtBQUs7MEJBQ0wsS0FBSzsrQkFDTCxLQUFLOzRCQUNMLEtBQUs7NkJBRUwsTUFBTTs0QkFDTixNQUFNOzBCQUNOLE1BQU07O0lBK0hULGNBQUM7Q0FBQSxBQTNJRCxJQTJJQztTQXhJWSxPQUFPOzs7SUFDbEIsZ0NBQTZCOztJQUM3QixnQ0FBNkI7O0lBQzdCLDBCQUF3Qjs7SUFDeEIsK0JBQThCOztJQUM5Qiw0QkFBMkM7O0lBRTNDLDZCQUErQzs7SUFDL0MsNEJBQThDOztJQUM5QywwQkFBK0M7O0lBRS9DLDBCQUFxQjs7Ozs7SUFHbkIsMEJBQTJCOzs7OztJQUMzQiwyQkFBMEI7Ozs7O0lBQzFCLDBCQUEyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERpcmVjdGl2ZSxcbiAgT25Jbml0LFxuICBFbGVtZW50UmVmLFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBFdmVudEVtaXR0ZXJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJb25Db250ZW50LCBQbGF0Zm9ybSB9IGZyb20gJ0Bpb25pYy9hbmd1bGFyJztcbmltcG9ydCB7IGZyb21FdmVudCwgbWVyZ2UgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIGZpbHRlcixcbiAgbWFwLFxuICBza2lwV2hpbGUsXG4gIHRha2VVbnRpbCxcbiAgdGFrZUxhc3Rcbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbZml2UHVsbF0nXG59KVxuZXhwb3J0IGNsYXNzIEZpdlB1bGwgaW1wbGVtZW50cyBPbkluaXQge1xuICBASW5wdXQoKSBtaW5QdWxsSGVpZ2h0ID0gMTEyO1xuICBASW5wdXQoKSBtYXhQdWxsSGVpZ2h0ID0gMTY4O1xuICBASW5wdXQoKSBlbmFibGVkID0gdHJ1ZTtcbiAgQElucHV0KCkgZW5hYmxlU2Nyb2xsID0gZmFsc2U7XG4gIEBJbnB1dCgpIGRpcmVjdGlvbjogJ3VwJyB8ICdkb3duJyA9ICdkb3duJztcblxuICBAT3V0cHV0KCkgZml2UmVmcmVzaCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBAT3V0cHV0KCkgZml2Q2FuY2VsID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoKSBmaXZQdWxsID0gbmV3IEV2ZW50RW1pdHRlcjxudW1iZXI+KCk7XG5cbiAgc2Nyb2xsWTogSFRNTEVsZW1lbnQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBlbGVtZW50OiBFbGVtZW50UmVmLFxuICAgIHByaXZhdGUgcGxhdGZvcm06IFBsYXRmb3JtLFxuICAgIHByaXZhdGUgY29udGVudDogSW9uQ29udGVudFxuICApIHsgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMuY29udGVudC5zY3JvbGxFdmVudHMgPSB0cnVlO1xuICAgIHRoaXMuY29udGVudC5nZXRTY3JvbGxFbGVtZW50KCkudGhlbihzID0+IHtcbiAgICAgIHRoaXMuc2Nyb2xsWSA9IHM7IC8vIG5lZWRlZCBmb3Igc2Nyb2xsVG9wXG4gICAgICB0aGlzLnNldHVwUGFuTGlzdGVuZXIoKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0dXBQYW5MaXN0ZW5lcigpIHtcbiAgICBjb25zdCB0b3VjaHN0YXJ0JCA9IGZyb21FdmVudCh0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudCwgJ3RvdWNoc3RhcnQnLCB7IHBhc3NpdmU6IHRydWUgfSk7XG4gICAgY29uc3QgdG91Y2htb3ZlJCA9IGZyb21FdmVudCh0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudCwgJ3RvdWNobW92ZScsIHsgcGFzc2l2ZTogdHJ1ZSB9KTtcbiAgICBjb25zdCB0b3VjaGVuZCQgPSBmcm9tRXZlbnQodGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQsICd0b3VjaGVuZCcsIHsgcGFzc2l2ZTogdHJ1ZSB9KTtcbiAgICBjb25zdCB0b3VjaGNhbmNlbCQgPSBmcm9tRXZlbnQodGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQsICd0b3VjaGNhbmNlbCcsIHsgcGFzc2l2ZTogdHJ1ZSB9KTtcbiAgICBjb25zdCBlbmQkID0gbWVyZ2UodG91Y2hlbmQkLCB0b3VjaGNhbmNlbCQpO1xuXG4gICAgY29uc3QgZHJhZ0F0VG9wID0gdG91Y2hzdGFydCQucGlwZShcbiAgICAgIGZpbHRlcihcbiAgICAgICAgZSA9PlxuICAgICAgICAgICh0aGlzLnNjcm9sbFkuc2Nyb2xsVG9wID09PSAwIHx8IHRoaXMuZW5hYmxlU2Nyb2xsKSAmJlxuICAgICAgICAgIHRoaXMuZGlyZWN0aW9uID09PSAnZG93bicgJiZcbiAgICAgICAgICB0aGlzLmVuYWJsZWRcbiAgICAgIClcbiAgICApO1xuXG4gICAgY29uc3QgZHJhZ0F0Qm90dG9tID0gdG91Y2hzdGFydCQucGlwZShcbiAgICAgIGZpbHRlcihcbiAgICAgICAgZSA9PlxuICAgICAgICAgICh0aGlzLnNjcm9sbFkuc2Nyb2xsVG9wID09PVxuICAgICAgICAgICAgdGhpcy5zY3JvbGxZLmNsaWVudEhlaWdodCAtIHRoaXMucGxhdGZvcm0uaGVpZ2h0KCkgfHxcbiAgICAgICAgICAgIHRoaXMuZW5hYmxlU2Nyb2xsKSAmJlxuICAgICAgICAgIHRoaXMuZGlyZWN0aW9uID09PSAndXAnICYmXG4gICAgICAgICAgdGhpcy5lbmFibGVkXG4gICAgICApXG4gICAgKTtcblxuICAgIGNvbnN0IGRyYWdUb3BEb3duID0gZHJhZ0F0VG9wLnBpcGUoXG4gICAgICBtYXAoKHN0YXJ0OiBhbnkpID0+IHtcbiAgICAgICAgY29uc3Qgc3RhcnRZID0gc3RhcnQudG91Y2hlc1swXS5wYWdlWTtcbiAgICAgICAgcmV0dXJuIHRvdWNobW92ZSQucGlwZShcbiAgICAgICAgICBtYXAoKG1vdmU6IGFueSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY3VycmVudFkgPSBtb3ZlLnRvdWNoZXNbMF0ucGFnZVk7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICBzdGFydEV2ZW50OiBzdGFydCxcbiAgICAgICAgICAgICAgbW92ZUV2ZW50OiBtb3ZlLFxuICAgICAgICAgICAgICBzdGFydFk6IHN0YXJ0WSxcbiAgICAgICAgICAgICAgY3VycmVudFk6IGN1cnJlbnRZLFxuICAgICAgICAgICAgICBvZmZzZXQ6IGN1cnJlbnRZIC0gc3RhcnRZXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0pLFxuICAgICAgICAgIHNraXBXaGlsZShkcmFnID0+IGRyYWcub2Zmc2V0IDwgMCksXG4gICAgICAgICAgdGFrZVVudGlsKGVuZCQpXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG5cbiAgICBkcmFnVG9wRG93bi5mb3JFYWNoKGRyYWdzID0+IHtcbiAgICAgIGRyYWdzLmZvckVhY2goZHJhZyA9PiB7XG4gICAgICAgIGNvbnN0IG9mZnNldCA9IGRyYWcub2Zmc2V0IC8gMjtcbiAgICAgICAgaWYgKG9mZnNldCA8IDAgfHwgb2Zmc2V0ID4gdGhpcy5tYXhQdWxsSGVpZ2h0KSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChvZmZzZXQgPD0gdGhpcy5tYXhQdWxsSGVpZ2h0KSB7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5maXZQdWxsLmVtaXQob2Zmc2V0IC8gdGhpcy5tYXhQdWxsSGVpZ2h0KTtcbiAgICAgIH0pO1xuXG4gICAgICBkcmFncy5waXBlKHRha2VMYXN0KDEpKS5zdWJzY3JpYmUoZHJhZyA9PiB7XG4gICAgICAgIGNvbnN0IG9mZnNldCA9IGRyYWcub2Zmc2V0IC8gMjtcbiAgICAgICAgY29uc3QgcmVmcmVzaCA9IG9mZnNldCA+PSB0aGlzLm1pblB1bGxIZWlnaHQ7XG4gICAgICAgIGlmIChyZWZyZXNoKSB7XG4gICAgICAgICAgdGhpcy5maXZSZWZyZXNoLmVtaXQob2Zmc2V0IC8gdGhpcy5tYXhQdWxsSGVpZ2h0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmZpdkNhbmNlbC5lbWl0KG9mZnNldCAvIHRoaXMubWF4UHVsbEhlaWdodCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgY29uc3QgZHJhZ0JvdHRvbVVwID0gZHJhZ0F0Qm90dG9tLnBpcGUoXG4gICAgICBtYXAoKHN0YXJ0OiBhbnkpID0+IHtcbiAgICAgICAgY29uc3Qgc3RhcnRZID0gc3RhcnQudG91Y2hlc1swXS5wYWdlWTtcbiAgICAgICAgcmV0dXJuIHRvdWNobW92ZSQucGlwZShcbiAgICAgICAgICBtYXAoKG1vdmU6IGFueSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY3VycmVudFkgPSBtb3ZlLnRvdWNoZXNbMF0ucGFnZVk7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICBzdGFydEV2ZW50OiBzdGFydCxcbiAgICAgICAgICAgICAgbW92ZUV2ZW50OiBtb3ZlLFxuICAgICAgICAgICAgICBzdGFydFk6IHN0YXJ0WSxcbiAgICAgICAgICAgICAgY3VycmVudFk6IGN1cnJlbnRZLFxuICAgICAgICAgICAgICBvZmZzZXQ6IHN0YXJ0WSAtIGN1cnJlbnRZXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0pLFxuICAgICAgICAgIHNraXBXaGlsZShkcmFnID0+IGRyYWcub2Zmc2V0IDwgMCksXG4gICAgICAgICAgdGFrZVVudGlsKGVuZCQpXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG5cbiAgICBkcmFnQm90dG9tVXAuZm9yRWFjaChkcmFncyA9PiB7XG4gICAgICBkcmFncy5mb3JFYWNoKGRyYWcgPT4ge1xuICAgICAgICBjb25zdCBvZmZzZXQgPSBkcmFnLm9mZnNldCAvIDI7XG4gICAgICAgIGlmIChvZmZzZXQgPCAwIHx8IG9mZnNldCA+IHRoaXMubWF4UHVsbEhlaWdodCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmZpdlB1bGwuZW1pdChvZmZzZXQgLyB0aGlzLm1heFB1bGxIZWlnaHQpO1xuICAgICAgfSk7XG5cbiAgICAgIGRyYWdzLnBpcGUodGFrZUxhc3QoMSkpLnN1YnNjcmliZShkcmFnID0+IHtcbiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZHJhZy5vZmZzZXQgLyAyO1xuICAgICAgICBjb25zdCByZWZyZXNoID0gb2Zmc2V0ID49IHRoaXMubWluUHVsbEhlaWdodDtcbiAgICAgICAgaWYgKHJlZnJlc2gpIHtcbiAgICAgICAgICB0aGlzLmZpdlJlZnJlc2guZW1pdChvZmZzZXQgLyB0aGlzLm1heFB1bGxIZWlnaHQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuZml2Q2FuY2VsLmVtaXQob2Zmc2V0IC8gdGhpcy5tYXhQdWxsSGVpZ2h0KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==