/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { Router, NavigationEnd } from '@angular/router';
import { filter } from 'rxjs/operators';
import { NavController, Platform } from '@ionic/angular';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "@ionic/angular";
/**
 * @record
 */
export function RoutingStateConfig() { }
if (false) {
    /** @type {?} */
    RoutingStateConfig.prototype.clearOn;
    /** @type {?} */
    RoutingStateConfig.prototype.root;
}
var FivRoutingStateService = /** @class */ (function () {
    function FivRoutingStateService(router, navCtrl, platform) {
        this.router = router;
        this.navCtrl = navCtrl;
        this.platform = platform;
        this.history = [];
    }
    /**
     * @param {?=} config
     * @return {?}
     */
    FivRoutingStateService.prototype.loadRouting = /**
     * @param {?=} config
     * @return {?}
     */
    function (config) {
        var _this = this;
        this.config = config;
        this.handleAndroidBackButton();
        this.router.events
            .pipe(filter((/**
         * @param {?} event
         * @return {?}
         */
        function (event) { return event instanceof NavigationEnd; })))
            .subscribe((/**
         * @param {?} __0
         * @return {?}
         */
        function (_a) {
            var urlAfterRedirects = _a.urlAfterRedirects;
            if (urlAfterRedirects === _this.getPreviousUrl(_this.config.root)) {
                _this.pop();
                _this.pop();
            }
            // add url to history
            _this.history.push(urlAfterRedirects);
            if (_this.config && _this.config.clearOn) {
                /** @type {?} */
                var clear = _this.config.clearOn.some((/**
                 * @param {?} s
                 * @return {?}
                 */
                function (s) { return s === urlAfterRedirects; }));
                if (clear) {
                    _this.clearHistory(urlAfterRedirects);
                }
            }
        }));
    };
    /**
     * @param {?} target
     * @return {?}
     */
    FivRoutingStateService.prototype.registerNavigateable = /**
     * @param {?} target
     * @return {?}
     */
    function (target) {
        if (isNavigateable(target)) {
            this.history.push(target);
        }
    };
    /**
     * @return {?}
     */
    FivRoutingStateService.prototype.handleAndroidBackButton = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.platform.backButton
            .pipe(filter((/**
         * @return {?}
         */
        function () { return !isNavigateable(_this.getCurrentUrl()); })))
            .subscribe((/**
         * @param {?} event
         * @return {?}
         */
        function (event) {
            _this.goBack();
        }));
        this.platform.backButton
            .pipe(filter((/**
         * @return {?}
         */
        function () { return isNavigateable(_this.getCurrentUrl()); })))
            .subscribe((/**
         * @param {?} event
         * @return {?}
         */
        function (event) {
            event.register(99999, (/**
             * @return {?}
             */
            function () {
                _this.goBack('/');
            }));
        }));
    };
    /**
     * @return {?}
     */
    FivRoutingStateService.prototype.getHistory = /**
     * @return {?}
     */
    function () {
        return this.history;
    };
    /**
     * @param {?=} defaultHref
     * @return {?}
     */
    FivRoutingStateService.prototype.getPreviousUrl = /**
     * @param {?=} defaultHref
     * @return {?}
     */
    function (defaultHref) {
        if (defaultHref === void 0) { defaultHref = '/'; }
        if (this.history.length > 2) {
            return this.history[this.history.length - 2];
        }
        return defaultHref;
    };
    /**
     * @return {?}
     */
    FivRoutingStateService.prototype.pop = /**
     * @return {?}
     */
    function () {
        return this.history.pop();
    };
    /**
     * @param {?} fromUrl
     * @return {?}
     */
    FivRoutingStateService.prototype.clearHistory = /**
     * @param {?} fromUrl
     * @return {?}
     */
    function (fromUrl) {
        var _this = this;
        this.history = this.history.filter((/**
         * @param {?} h
         * @return {?}
         */
        function (h) {
            return _this.config.clearOn.some((/**
             * @param {?} s
             * @return {?}
             */
            function (s) { return s === h; }));
        }));
        if (fromUrl !== this.config.root) {
            this.history.push(fromUrl);
        }
        this.history = this.history
            .reverse()
            .filter((/**
         * @param {?} item
         * @param {?} pos
         * @param {?} self
         * @return {?}
         */
        function (item, pos, self) {
            return self.indexOf(item) === pos;
        }))
            .reverse();
        if (this.history[0] !== this.config.root) {
            this.history = tslib_1.__spread([this.config.root], this.history);
        }
    };
    /**
     * @return {?}
     */
    FivRoutingStateService.prototype.getCurrentUrl = /**
     * @return {?}
     */
    function () {
        return this.history[this.history.length - 1];
    };
    /**
     * @param {?=} defaultHref
     * @return {?}
     */
    FivRoutingStateService.prototype.goBack = /**
     * @param {?=} defaultHref
     * @return {?}
     */
    function (defaultHref) {
        if (defaultHref === void 0) { defaultHref = '/'; }
        if (this.getHistory().length <= 1) {
            // close the app because we are at root level
            return navigator['app'].exitApp();
        }
        /** @type {?} */
        var current = this.getCurrentUrl();
        if (typeof current !== 'string' && isNavigateable(current)) {
            current.dismiss();
            return this.pop();
        }
        /** @type {?} */
        var previous = this.getPreviousUrl(defaultHref);
        if (typeof previous === 'string') {
            return this.navCtrl.navigateBack(previous);
        }
        if (isNavigateable(previous)) {
            return this.navCtrl.navigateBack(this.getLatestUrl(defaultHref));
        }
    };
    /**
     * @param {?} defaultHref
     * @return {?}
     */
    FivRoutingStateService.prototype.getLatestUrl = /**
     * @param {?} defaultHref
     * @return {?}
     */
    function (defaultHref) {
        /** @type {?} */
        var urls = this.history.filter((/**
         * @param {?} e
         * @return {?}
         */
        function (e) { return !!(typeof e === 'string'); }));
        /** @type {?} */
        var latest = urls[urls.length - 1];
        if (urls.length > 0 && latest && typeof latest === 'string') {
            return latest;
        }
        return defaultHref;
    };
    FivRoutingStateService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    FivRoutingStateService.ctorParameters = function () { return [
        { type: Router },
        { type: NavController },
        { type: Platform }
    ]; };
    /** @nocollapse */ FivRoutingStateService.ngInjectableDef = i0.defineInjectable({ factory: function FivRoutingStateService_Factory() { return new FivRoutingStateService(i0.inject(i1.Router), i0.inject(i2.NavController), i0.inject(i2.Platform)); }, token: FivRoutingStateService, providedIn: "root" });
    return FivRoutingStateService;
}());
export { FivRoutingStateService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    FivRoutingStateService.prototype.history;
    /**
     * @type {?}
     * @private
     */
    FivRoutingStateService.prototype.config;
    /**
     * @type {?}
     * @private
     */
    FivRoutingStateService.prototype.router;
    /**
     * @type {?}
     * @private
     */
    FivRoutingStateService.prototype.navCtrl;
    /**
     * @type {?}
     * @private
     */
    FivRoutingStateService.prototype.platform;
}
/**
 * @param {?} object
 * @return {?}
 */
export function isNavigateable(object) {
    return !!object && object.dismiss !== undefined;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGluZy1zdGF0ZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZpdmV0aHJlZS9jb3JlLyIsInNvdXJjZXMiOlsibGliL2JhY2stYnV0dG9uL3JvdXRpbmctc3RhdGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxhQUFhLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsTUFBTSxFQUFrQixNQUFNLGdCQUFnQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7Ozs7Ozs7QUFJekQsd0NBR0M7OztJQUZDLHFDQUFrQjs7SUFDbEIsa0NBQWE7O0FBR2Y7SUFPRSxnQ0FDVSxNQUFjLEVBQ2QsT0FBc0IsRUFDdEIsUUFBa0I7UUFGbEIsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLFlBQU8sR0FBUCxPQUFPLENBQWU7UUFDdEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQU5wQixZQUFPLEdBQThCLEVBQUUsQ0FBQztJQU83QyxDQUFDOzs7OztJQUVHLDRDQUFXOzs7O0lBQWxCLFVBQW1CLE1BQTJCO1FBQTlDLGlCQW1CQztRQWxCQyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU07YUFDZixJQUFJLENBQUMsTUFBTTs7OztRQUFDLFVBQUEsS0FBSyxJQUFJLE9BQUEsS0FBSyxZQUFZLGFBQWEsRUFBOUIsQ0FBOEIsRUFBQyxDQUFDO2FBQ3JELFNBQVM7Ozs7UUFBQyxVQUFDLEVBQW9DO2dCQUFsQyx3Q0FBaUI7WUFDN0IsSUFBSSxpQkFBaUIsS0FBSyxLQUFJLENBQUMsY0FBYyxDQUFDLEtBQUksQ0FBQyxNQUFNLENB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Y2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSb3V0ZXIsIE5hdmlnYXRpb25FbmQgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgZmlsdGVyLCB0YXAsIHRha2VXaGlsZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IE5hdkNvbnRyb2xsZXIsIFBsYXRmb3JtIH0gZnJvbSAnQGlvbmljL2FuZ3VsYXInO1xuaW1wb3J0IHsgTmF2aWdhdGVhYmxlIH0gZnJvbSAnLi4vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBmcm9tRXZlbnQsIHppcCwgcmFjZSwgZnJvbSB9IGZyb20gJ3J4anMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFJvdXRpbmdTdGF0ZUNvbmZpZyB7XG4gIGNsZWFyT246IHN0cmluZ1tdO1xuICByb290OiBzdHJpbmc7XG59XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEZpdlJvdXRpbmdTdGF0ZVNlcnZpY2Uge1xuICBwcml2YXRlIGhpc3Rvcnk6IChzdHJpbmcgfCBOYXZpZ2F0ZWFibGUpW10gPSBbXTtcbiAgcHJpdmF0ZSBjb25maWc6IFJvdXRpbmdTdGF0ZUNvbmZpZztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgbmF2Q3RybDogTmF2Q29udHJvbGxlcixcbiAgICBwcml2YXRlIHBsYXRmb3JtOiBQbGF0Zm9ybVxuICApIHt9XG5cbiAgcHVibGljIGxvYWRSb3V0aW5nKGNvbmZpZz86IFJvdXRpbmdTdGF0ZUNvbmZpZyk6IHZvaWQge1xuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgIHRoaXMuaGFuZGxlQW5kcm9pZEJhY2tCdXR0b24oKTtcbiAgICB0aGlzLnJvdXRlci5ldmVudHNcbiAgICAgIC5waXBlKGZpbHRlcihldmVudCA9PiBldmVudCBpbnN0YW5jZW9mIE5hdmlnYXRpb25FbmQpKVxuICAgICAgLnN1YnNjcmliZSgoeyB1cmxBZnRlclJlZGlyZWN0cyB9OiBOYXZpZ2F0aW9uRW5kKSA9PiB7XG4gICAgICAgIGlmICh1cmxBZnRlclJlZGlyZWN0cyA9PT0gdGhpcy5nZXRQcmV2aW91c1VybCh0aGlzLmNvbmZpZy5yb290KSkge1xuICAgICAgICAgIHRoaXMucG9wKCk7XG4gICAgICAgICAgdGhpcy5wb3AoKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBhZGQgdXJsIHRvIGhpc3RvcnlcbiAgICAgICAgdGhpcy5oaXN0b3J5LnB1c2godXJsQWZ0ZXJSZWRpcmVjdHMpO1xuICAgICAgICBpZiAodGhpcy5jb25maWcgJiYgdGhpcy5jb25maWcuY2xlYXJPbikge1xuICAgICAgICAgIGNvbnN0IGNsZWFyID0gdGhpcy5jb25maWcuY2xlYXJPbi5zb21lKHMgPT4gcyA9PT0gdXJsQWZ0ZXJSZWRpcmVjdHMpO1xuICAgICAgICAgIGlmIChjbGVhcikge1xuICAgICAgICAgICAgdGhpcy5jbGVhckhpc3RvcnkodXJsQWZ0ZXJSZWRpcmVjdHMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICByZWdpc3Rlck5hdmlnYXRlYWJsZSh0YXJnZXQ6IE5hdmlnYXRlYWJsZSkge1xuICAgIGlmIChpc05hdmlnYXRlYWJsZSh0YXJnZXQpKSB7XG4gICAgICB0aGlzLmhpc3RvcnkucHVzaCh0YXJnZXQpO1xuICAgIH1cbiAgfVxuXG4gIGhhbmRsZUFuZHJvaWRCYWNrQnV0dG9uKCkge1xuICAgIHRoaXMucGxhdGZvcm0uYmFja0J1dHRvblxuICAgICAgLnBpcGUoZmlsdGVyKCgpID0+ICFpc05hdmlnYXRlYWJsZSh0aGlzLmdldEN1cnJlbnRVcmwoKSkpKVxuICAgICAgLnN1YnNjcmliZShldmVudCA9PiB7XG4gICAgICAgIHRoaXMuZ29CYWNrKCk7XG4gICAgICB9KTtcblxuICAgIHRoaXMucGxhdGZvcm0uYmFja0J1dHRvblxuICAgICAgLnBpcGUoZmlsdGVyKCgpID0+IGlzTmF2aWdhdGVhYmxlKHRoaXMuZ2V0Q3VycmVudFVybCgpKSkpXG4gICAgICAuc3Vic2NyaWJlKGV2ZW50ID0+IHtcbiAgICAgICAgZXZlbnQucmVnaXN0ZXIoOTk5OTksICgpID0+IHtcbiAgICAgICAgICB0aGlzLmdvQmFjaygnLycpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldEhpc3RvcnkoKTogKHN0cmluZyB8IE5hdmlnYXRlYWJsZSlbXSB7XG4gICAgcmV0dXJuIHRoaXMuaGlzdG9yeTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRQcmV2aW91c1VybChkZWZhdWx0SHJlZiA9ICcvJyk6IHN0cmluZyB8IE5hdmlnYXRlYWJsZSB7XG4gICAgaWYgKHRoaXMuaGlzdG9yeS5sZW5ndGggPiAyKSB7XG4gICAgICByZXR1cm4gdGhpcy5oaXN0b3J5W3RoaXMuaGlzdG9yeS5sZW5ndGggLSAyXTtcbiAgICB9XG4gICAgcmV0dXJuIGRlZmF1bHRIcmVmO1xuICB9XG5cbiAgcHVibGljIHBvcCgpOiBzdHJpbmcgfCBOYXZpZ2F0ZWFibGUge1xuICAgIHJldHVybiB0aGlzLmhpc3RvcnkucG9wKCk7XG4gIH1cblxuICBwdWJsaWMgY2xlYXJIaXN0b3J5KGZyb21Vcmw6IHN0cmluZykge1xuICAgIHRoaXMuaGlzdG9yeSA9IHRoaXMuaGlzdG9yeS5maWx0ZXIoaCA9PlxuICAgICAgdGhpcy5jb25maWcuY2xlYXJPbi5zb21lKHMgPT4gcyA9PT0gaClcbiAgICApO1xuICAgIGlmIChmcm9tVXJsICE9PSB0aGlzLmNvbmZpZy5yb290KSB7XG4gICAgICB0aGlzLmhpc3RvcnkucHVzaChmcm9tVXJsKTtcbiAgICB9XG4gICAgdGhpcy5oaXN0b3J5ID0gdGhpcy5oaXN0b3J5XG4gICAgICAucmV2ZXJzZSgpXG4gICAgICAuZmlsdGVyKGZ1bmN0aW9uKGl0ZW0sIHBvcywgc2VsZikge1xuICAgICAgICByZXR1cm4gc2VsZi5pbmRleE9mKGl0ZW0pID09PSBwb3M7XG4gICAgICB9KVxuICAgICAgLnJldmVyc2UoKTtcbiAgICBpZiAodGhpcy5oaXN0b3J5WzBdICE9PSB0aGlzLmNvbmZpZy5yb290KSB7XG4gICAgICB0aGlzLmhpc3RvcnkgPSBbdGhpcy5jb25maWcucm9vdCwgLi4udGhpcy5oaXN0b3J5XTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0Q3VycmVudFVybCgpOiBzdHJpbmcgfCBOYXZpZ2F0ZWFibGUge1xuICAgIHJldHVybiB0aGlzLmhpc3RvcnlbdGhpcy5oaXN0b3J5Lmxlbmd0aCAtIDFdO1xuICB9XG5cbiAgZ29CYWNrKGRlZmF1bHRIcmVmID0gJy8nKSB7XG4gICAgaWYgKHRoaXMuZ2V0SGlzdG9yeSgpLmxlbmd0aCA8PSAxKSB7XG4gICAgICAvLyBjbG9zZSB0aGUgYXBwIGJlY2F1c2Ugd2UgYXJlIGF0IHJvb3QgbGV2ZWxcbiAgICAgIHJldHVybiBuYXZpZ2F0b3JbJ2FwcCddLmV4aXRBcHAoKTtcbiAgICB9XG4gICAgY29uc3QgY3VycmVudCA9IHRoaXMuZ2V0Q3VycmVudFVybCgpO1xuICAgIGlmICh0eXBlb2YgY3VycmVudCAhPT0gJ3N0cmluZycgJiYgaXNOYXZpZ2F0ZWFibGUoY3VycmVudCkpIHtcbiAgICAgIGN1cnJlbnQuZGlzbWlzcygpO1xuICAgICAgcmV0dXJuIHRoaXMucG9wKCk7XG4gICAgfVxuXG4gICAgY29uc3QgcHJldmlvdXMgPSB0aGlzLmdldFByZXZpb3VzVXJsKGRlZmF1bHRIcmVmKTtcbiAgICBpZiAodHlwZW9mIHByZXZpb3VzID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIHRoaXMubmF2Q3RybC5uYXZpZ2F0ZUJhY2socHJldmlvdXMpO1xuICAgIH1cbiAgICBpZiAoaXNOYXZpZ2F0ZWFibGUocHJldmlvdXMpKSB7XG4gICAgICByZXR1cm4gdGhpcy5uYXZDdHJsLm5hdmlnYXRlQmFjayh0aGlzLmdldExhdGVzdFVybChkZWZhdWx0SHJlZikpO1xuICAgIH1cbiAgfVxuXG4gIGdldExhdGVzdFVybChkZWZhdWx0SHJlZjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCB1cmxzID0gdGhpcy5oaXN0b3J5LmZpbHRlcihlID0+ICEhKHR5cGVvZiBlID09PSAnc3RyaW5nJykpO1xuICAgIGNvbnN0IGxhdGVzdCA9IHVybHNbdXJscy5sZW5ndGggLSAxXTtcbiAgICBpZiAodXJscy5sZW5ndGggPiAwICYmIGxhdGVzdCAmJiB0eXBlb2YgbGF0ZXN0ID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIGxhdGVzdDtcbiAgICB9XG4gICAgcmV0dXJuIGRlZmF1bHRIcmVmO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc05hdmlnYXRlYWJsZShvYmplY3Q6IGFueSk6IGJvb2xlYW4ge1xuICByZXR1cm4gISFvYmplY3QgJiYgb2JqZWN0LmRpc21pc3MgIT09IHVuZGVmaW5lZDtcbn1cbiJdfQ==