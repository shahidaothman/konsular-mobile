/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { Router, NavigationEnd } from '@angular/router';
import { filter } from 'rxjs/operators';
import { NavController, Platform } from '@ionic/angular';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "@ionic/angular";
/**
 * @record
 */
export function RoutingStateConfig() { }
if (false) {
    /** @type {?} */
    RoutingStateConfig.prototype.clearOn;
    /** @type {?} */
    RoutingStateConfig.prototype.root;
}
export class FivRoutingStateService {
    /**
     * @param {?} router
     * @param {?} navCtrl
     * @param {?} platform
     */
    constructor(router, navCtrl, platform) {
        this.router = router;
        this.navCtrl = navCtrl;
        this.platform = platform;
        this.history = [];
    }
    /**
     * @param {?=} config
     * @return {?}
     */
    loadRouting(config) {
        this.config = config;
        this.handleAndroidBackButton();
        this.router.events
            .pipe(filter((/**
         * @param {?} event
         * @return {?}
         */
        event => event instanceof NavigationEnd)))
            .subscribe((/**
         * @param {?} __0
         * @return {?}
         */
        ({ urlAfterRedirects }) => {
            if (urlAfterRedirects === this.getPreviousUrl(this.config.root)) {
                this.pop();
                this.pop();
            }
            // add url to history
            this.history.push(urlAfterRedirects);
            if (this.config && this.config.clearOn) {
                /** @type {?} */
                const clear = this.config.clearOn.some((/**
                 * @param {?} s
                 * @return {?}
                 */
                s => s === urlAfterRedirects));
                if (clear) {
                    this.clearHistory(urlAfterRedirects);
                }
            }
        }));
    }
    /**
     * @param {?} target
     * @return {?}
     */
    registerNavigateable(target) {
        if (isNavigateable(target)) {
            this.history.push(target);
        }
    }
    /**
     * @return {?}
     */
    handleAndroidBackButton() {
        this.platform.backButton
            .pipe(filter((/**
         * @return {?}
         */
        () => !isNavigateable(this.getCurrentUrl()))))
            .subscribe((/**
         * @param {?} event
         * @return {?}
         */
        event => {
            this.goBack();
        }));
        this.platform.backButton
            .pipe(filter((/**
         * @return {?}
         */
        () => isNavigateable(this.getCurrentUrl()))))
            .subscribe((/**
         * @param {?} event
         * @return {?}
         */
        event => {
            event.register(99999, (/**
             * @return {?}
             */
            () => {
                this.goBack('/');
            }));
        }));
    }
    /**
     * @return {?}
     */
    getHistory() {
        return this.history;
    }
    /**
     * @param {?=} defaultHref
     * @return {?}
     */
    getPreviousUrl(defaultHref = '/') {
        if (this.history.length > 2) {
            return this.history[this.history.length - 2];
        }
        return defaultHref;
    }
    /**
     * @return {?}
     */
    pop() {
        return this.history.pop();
    }
    /**
     * @param {?} fromUrl
     * @return {?}
     */
    clearHistory(fromUrl) {
        this.history = this.history.filter((/**
         * @param {?} h
         * @return {?}
         */
        h => this.config.clearOn.some((/**
         * @param {?} s
         * @return {?}
         */
        s => s === h))));
        if (fromUrl !== this.config.root) {
            this.history.push(fromUrl);
        }
        this.history = this.history
            .reverse()
            .filter((/**
         * @param {?} item
         * @param {?} pos
         * @param {?} self
         * @return {?}
         */
        function (item, pos, self) {
            return self.indexOf(item) === pos;
        }))
            .reverse();
        if (this.history[0] !== this.config.root) {
            this.history = [this.config.root, ...this.history];
        }
    }
    /**
     * @return {?}
     */
    getCurrentUrl() {
        return this.history[this.history.length - 1];
    }
    /**
     * @param {?=} defaultHref
     * @return {?}
     */
    goBack(defaultHref = '/') {
        if (this.getHistory().length <= 1) {
            // close the app because we are at root level
            return navigator['app'].exitApp();
        }
        /** @type {?} */
        const current = this.getCurrentUrl();
        if (typeof current !== 'string' && isNavigateable(current)) {
            current.dismiss();
            return this.pop();
        }
        /** @type {?} */
        const previous = this.getPreviousUrl(defaultHref);
        if (typeof previous === 'string') {
            return this.navCtrl.navigateBack(previous);
        }
        if (isNavigateable(previous)) {
            return this.navCtrl.navigateBack(this.getLatestUrl(defaultHref));
        }
    }
    /**
     * @param {?} defaultHref
     * @return {?}
     */
    getLatestUrl(defaultHref) {
        /** @type {?} */
        const urls = this.history.filter((/**
         * @param {?} e
         * @return {?}
         */
        e => !!(typeof e === 'string')));
        /** @type {?} */
        const latest = urls[urls.length - 1];
        if (urls.length > 0 && latest && typeof latest === 'string') {
            return latest;
        }
        return defaultHref;
    }
}
FivRoutingStateService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
FivRoutingStateService.ctorParameters = () => [
    { type: Router },
    { type: NavController },
    { type: Platform }
];
/** @nocollapse */ FivRoutingStateService.ngInjectableDef = i0.defineInjectable({ factory: function FivRoutingStateService_Factory() { return new FivRoutingStateService(i0.inject(i1.Router), i0.inject(i2.NavController), i0.inject(i2.Platform)); }, token: FivRoutingStateService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    FivRoutingStateService.prototype.history;
    /**
     * @type {?}
     * @private
     */
    FivRoutingStateService.prototype.config;
    /**
     * @type {?}
     * @private
     */
    FivRoutingStateService.prototype.router;
    /**
     * @type {?}
     * @private
     */
    FivRoutingStateService.prototype.navCtrl;
    /**
     * @type {?}
     * @private
     */
    FivRoutingStateService.prototype.platform;
}
/**
 * @param {?} object
 * @return {?}
 */
export function isNavigateable(object) {
    return !!object && object.dismiss !== undefined;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGluZy1zdGF0ZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZpdmV0aHJlZS9jb3JlLyIsInNvdXJjZXMiOlsibGliL2JhY2stYnV0dG9uL3JvdXRpbmctc3RhdGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxNQUFNLEVBQWtCLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7Ozs7OztBQUl6RCx3Q0FHQzs7O0lBRkMscUNBQWtCOztJQUNsQixrQ0FBYTs7QUFNZixNQUFNLE9BQU8sc0JBQXNCOzs7Ozs7SUFJakMsWUFDVSxNQUFjLEVBQ2QsT0FBc0IsRUFDdEIsUUFBa0I7UUFGbEIsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLFlBQU8sR0FBUCxPQUFPLENBQWU7UUFDdEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQU5wQixZQUFPLEdBQThCLEVBQUUsQ0FBQztJQU83QyxDQUFDOzs7OztJQUVHLFdBQVcsQ0FBQyxNQUEyQjtRQUM1QyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU07YUFDZixJQUFJLENBQUMsTUFBTTs7OztRQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxZQUFZLGFBQWEsRUFBQyxDQUFDO2FBQ3JELFNBQVM7Ozs7UUFBQyxDQUFDLEVBQUUsaUJBQWlCLEVBQWlCLEVBQUUsRUFBRTtZQUNsRCxJQUFJLGlCQUFpQixLQUFLLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJ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T0FBTyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7U0FDbEU7SUFDSCxDQUFDOzs7OztJQUVELFlBQVksQ0FBQyxXQUFtQjs7Y0FDeEIsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTTs7OztRQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssUUFBUSxDQUFDLEVBQUM7O2NBQzFELE1BQU0sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFDcEMsSUFBSSxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxNQUFNLElBQUksT0FBTyxNQUFNLEtBQUssUUFBUSxFQUFFO1lBQzNELE9BQU8sTUFBTSxDQUFDO1NBQ2Y7UUFDRCxPQUFPLFdBQVcsQ0FBQztJQUNyQixDQUFDOzs7WUF4SEYsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7O1lBYlEsTUFBTTtZQUVOLGFBQWE7WUFBRSxRQUFROzs7Ozs7OztJQWE5Qix5Q0FBZ0Q7Ozs7O0lBQ2hELHdDQUFtQzs7Ozs7SUFHakMsd0NBQXNCOzs7OztJQUN0Qix5Q0FBOEI7Ozs7O0lBQzlCLDBDQUEwQjs7Ozs7O0FBaUg5QixNQUFNLFVBQVUsY0FBYyxDQUFDLE1BQVc7SUFDeEMsT0FBTyxDQUFDLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxPQUFPLEtBQUssU0FBUyxDQUFDO0FBQ2xELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSb3V0ZXIsIE5hdmlnYXRpb25FbmQgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgZmlsdGVyLCB0YXAsIHRha2VXaGlsZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IE5hdkNvbnRyb2xsZXIsIFBsYXRmb3JtIH0gZnJvbSAnQGlvbmljL2FuZ3VsYXInO1xuaW1wb3J0IHsgTmF2aWdhdGVhYmxlIH0gZnJvbSAnLi4vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBmcm9tRXZlbnQsIHppcCwgcmFjZSwgZnJvbSB9IGZyb20gJ3J4anMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFJvdXRpbmdTdGF0ZUNvbmZpZyB7XG4gIGNsZWFyT246IHN0cmluZ1tdO1xuICByb290OiBzdHJpbmc7XG59XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEZpdlJvdXRpbmdTdGF0ZVNlcnZpY2Uge1xuICBwcml2YXRlIGhpc3Rvcnk6IChzdHJpbmcgfCBOYXZpZ2F0ZWFibGUpW10gPSBbXTtcbiAgcHJpdmF0ZSBjb25maWc6IFJvdXRpbmdTdGF0ZUNvbmZpZztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgbmF2Q3RybDogTmF2Q29udHJvbGxlcixcbiAgICBwcml2YXRlIHBsYXRmb3JtOiBQbGF0Zm9ybVxuICApIHt9XG5cbiAgcHVibGljIGxvYWRSb3V0aW5nKGNvbmZpZz86IFJvdXRpbmdTdGF0ZUNvbmZpZyk6IHZvaWQge1xuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgIHRoaXMuaGFuZGxlQW5kcm9pZEJhY2tCdXR0b24oKTtcbiAgICB0aGlzLnJvdXRlci5ldmVudHNcbiAgICAgIC5waXBlKGZpbHRlcihldmVudCA9PiBldmVudCBpbnN0YW5jZW9mIE5hdmlnYXRpb25FbmQpKVxuICAgICAgLnN1YnNjcmliZSgoeyB1cmxBZnRlclJlZGlyZWN0cyB9OiBOYXZpZ2F0aW9uRW5kKSA9PiB7XG4gICAgICAgIGlmICh1cmxBZnRlclJlZGlyZWN0cyA9PT0gdGhpcy5nZXRQcmV2aW91c1VybCh0aGlzLmNvbmZpZy5yb290KSkge1xuICAgICAgICAgIHRoaXMucG9wKCk7XG4gICAgICAgICAgdGhpcy5wb3AoKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBhZGQgdXJsIHRvIGhpc3RvcnlcbiAgICAgICAgdGhpcy5oaXN0b3J5LnB1c2godXJsQWZ0ZXJSZWRpcmVjdHMpO1xuICAgICAgICBpZiAodGhpcy5jb25maWcgJiYgdGhpcy5jb25maWcuY2xlYXJPbikge1xuICAgICAgICAgIGNvbnN0IGNsZWFyID0gdGhpcy5jb25maWcuY2xlYXJPbi5zb21lKHMgPT4gcyA9PT0gdXJsQWZ0ZXJSZWRpcmVjdHMpO1xuICAgICAgICAgIGlmIChjbGVhcikge1xuICAgICAgICAgICAgdGhpcy5jbGVhckhpc3RvcnkodXJsQWZ0ZXJSZWRpcmVjdHMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICByZWdpc3Rlck5hdmlnYXRlYWJsZSh0YXJnZXQ6IE5hdmlnYXRlYWJsZSkge1xuICAgIGlmIChpc05hdmlnYXRlYWJsZSh0YXJnZXQpKSB7XG4gICAgICB0aGlzLmhpc3RvcnkucHVzaCh0YXJnZXQpO1xuICAgIH1cbiAgfVxuXG4gIGhhbmRsZUFuZHJvaWRCYWNrQnV0dG9uKCkge1xuICAgIHRoaXMucGxhdGZvcm0uYmFja0J1dHRvblxuICAgICAgLnBpcGUoZmlsdGVyKCgpID0+ICFpc05hdmlnYXRlYWJsZSh0aGlzLmdldEN1cnJlbnRVcmwoKSkpKVxuICAgICAgLnN1YnNjcmliZShldmVudCA9PiB7XG4gICAgICAgIHRoaXMuZ29CYWNrKCk7XG4gICAgICB9KTtcblxuICAgIHRoaXMucGxhdGZvcm0uYmFja0J1dHRvblxuICAgICAgLnBpcGUoZmlsdGVyKCgpID0+IGlzTmF2aWdhdGVhYmxlKHRoaXMuZ2V0Q3VycmVudFVybCgpKSkpXG4gICAgICAuc3Vic2NyaWJlKGV2ZW50ID0+IHtcbiAgICAgICAgZXZlbnQucmVnaXN0ZXIoOTk5OTksICgpID0+IHtcbiAgICAgICAgICB0aGlzLmdvQmFjaygnLycpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldEhpc3RvcnkoKTogKHN0cmluZyB8IE5hdmlnYXRlYWJsZSlbXSB7XG4gICAgcmV0dXJuIHRoaXMuaGlzdG9yeTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRQcmV2aW91c1VybChkZWZhdWx0SHJlZiA9ICcvJyk6IHN0cmluZyB8IE5hdmlnYXRlYWJsZSB7XG4gICAgaWYgKHRoaXMuaGlzdG9yeS5sZW5ndGggPiAyKSB7XG4gICAgICByZXR1cm4gdGhpcy5oaXN0b3J5W3RoaXMuaGlzdG9yeS5sZW5ndGggLSAyXTtcbiAgICB9XG4gICAgcmV0dXJuIGRlZmF1bHRIcmVmO1xuICB9XG5cbiAgcHVibGljIHBvcCgpOiBzdHJpbmcgfCBOYXZpZ2F0ZWFibGUge1xuICAgIHJldHVybiB0aGlzLmhpc3RvcnkucG9wKCk7XG4gIH1cblxuICBwdWJsaWMgY2xlYXJIaXN0b3J5KGZyb21Vcmw6IHN0cmluZykge1xuICAgIHRoaXMuaGlzdG9yeSA9IHRoaXMuaGlzdG9yeS5maWx0ZXIoaCA9PlxuICAgICAgdGhpcy5jb25maWcuY2xlYXJPbi5zb21lKHMgPT4gcyA9PT0gaClcbiAgICApO1xuICAgIGlmIChmcm9tVXJsICE9PSB0aGlzLmNvbmZpZy5yb290KSB7XG4gICAgICB0aGlzLmhpc3RvcnkucHVzaChmcm9tVXJsKTtcbiAgICB9XG4gICAgdGhpcy5oaXN0b3J5ID0gdGhpcy5oaXN0b3J5XG4gICAgICAucmV2ZXJzZSgpXG4gICAgICAuZmlsdGVyKGZ1bmN0aW9uKGl0ZW0sIHBvcywgc2VsZikge1xuICAgICAgICByZXR1cm4gc2VsZi5pbmRleE9mKGl0ZW0pID09PSBwb3M7XG4gICAgICB9KVxuICAgICAgLnJldmVyc2UoKTtcbiAgICBpZiAodGhpcy5oaXN0b3J5WzBdICE9PSB0aGlzLmNvbmZpZy5yb290KSB7XG4gICAgICB0aGlzLmhpc3RvcnkgPSBbdGhpcy5jb25maWcucm9vdCwgLi4udGhpcy5oaXN0b3J5XTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0Q3VycmVudFVybCgpOiBzdHJpbmcgfCBOYXZpZ2F0ZWFibGUge1xuICAgIHJldHVybiB0aGlzLmhpc3RvcnlbdGhpcy5oaXN0b3J5Lmxlbmd0aCAtIDFdO1xuICB9XG5cbiAgZ29CYWNrKGRlZmF1bHRIcmVmID0gJy8nKSB7XG4gICAgaWYgKHRoaXMuZ2V0SGlzdG9yeSgpLmxlbmd0aCA8PSAxKSB7XG4gICAgICAvLyBjbG9zZSB0aGUgYXBwIGJlY2F1c2Ugd2UgYXJlIGF0IHJvb3QgbGV2ZWxcbiAgICAgIHJldHVybiBuYXZpZ2F0b3JbJ2FwcCddLmV4aXRBcHAoKTtcbiAgICB9XG4gICAgY29uc3QgY3VycmVudCA9IHRoaXMuZ2V0Q3VycmVudFVybCgpO1xuICAgIGlmICh0eXBlb2YgY3VycmVudCAhPT0gJ3N0cmluZycgJiYgaXNOYXZpZ2F0ZWFibGUoY3VycmVudCkpIHtcbiAgICAgIGN1cnJlbnQuZGlzbWlzcygpO1xuICAgICAgcmV0dXJuIHRoaXMucG9wKCk7XG4gICAgfVxuXG4gICAgY29uc3QgcHJldmlvdXMgPSB0aGlzLmdldFByZXZpb3VzVXJsKGRlZmF1bHRIcmVmKTtcbiAgICBpZiAodHlwZW9mIHByZXZpb3VzID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIHRoaXMubmF2Q3RybC5uYXZpZ2F0ZUJhY2socHJldmlvdXMpO1xuICAgIH1cbiAgICBpZiAoaXNOYXZpZ2F0ZWFibGUocHJldmlvdXMpKSB7XG4gICAgICByZXR1cm4gdGhpcy5uYXZDdHJsLm5hdmlnYXRlQmFjayh0aGlzLmdldExhdGVzdFVybChkZWZhdWx0SHJlZikpO1xuICAgIH1cbiAgfVxuXG4gIGdldExhdGVzdFVybChkZWZhdWx0SHJlZjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCB1cmxzID0gdGhpcy5oaXN0b3J5LmZpbHRlcihlID0+ICEhKHR5cGVvZiBlID09PSAnc3RyaW5nJykpO1xuICAgIGNvbnN0IGxhdGVzdCA9IHVybHNbdXJscy5sZW5ndGggLSAxXTtcbiAgICBpZiAodXJscy5sZW5ndGggPiAwICYmIGxhdGVzdCAmJiB0eXBlb2YgbGF0ZXN0ID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIGxhdGVzdDtcbiAgICB9XG4gICAgcmV0dXJuIGRlZmF1bHRIcmVmO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc05hdmlnYXRlYWJsZShvYmplY3Q6IGFueSk6IGJvb2xlYW4ge1xuICByZXR1cm4gISFvYmplY3QgJiYgb2JqZWN0LmRpc21pc3MgIT09IHVuZGVmaW5lZDtcbn1cbiJdfQ==